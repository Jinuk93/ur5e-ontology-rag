# ============================================================
# rules.yaml - 엔티티 정규화/링킹 룰
# ============================================================
# 정규식 패턴과 매칭 규칙을 정의합니다.
# EntityLinker가 이 파일을 로드하여 정규화에 사용합니다.
# ============================================================

# ------------------------------------------------------------
# 에러 코드 정규화 룰
# ------------------------------------------------------------
error_code:
  # 정규식 패턴 (우선순위 순)
  patterns:
    # C4A15, C50A100 형태 (세부 코드)
    - name: "full_format"
      regex: 'C-?\s*(\d+)\s*A-?\s*(\d+)'
      normalize: 'C{1}A{2}'
      examples:
        - "C-4A15 → C4A15"
        - "C50-A100 → C50A100"
        - "C 4 A 15 → C4A15"

    # C4, C50 형태 (기본 코드)
    - name: "base_format"
      regex: 'C-?\s*(\d+)(?![A\d])'
      normalize: 'C{1}'
      examples:
        - "C-4 → C4"
        - "C 50 → C50"
        - "C119 → C119"

  # 유효성 검증
  validation:
    # 기본 코드 범위 (C0 ~ C55)
    base_range: [0, 55]
    # 에러 코드 최대 길이
    max_length: 10

  # 대소문자 정책
  case_policy: "upper"  # 항상 대문자로 정규화

# ------------------------------------------------------------
# 부품명 매칭 룰
# ------------------------------------------------------------
component:
  # 매칭 순서 (우선순위)
  matching:
    order:
      - "lexicon"     # 1. 동의어 사전 매칭 (가장 정확)
      - "regex"       # 2. 정규식 패턴 매칭
      - "embedding"   # 3. 임베딩 유사도 (fallback)

    # 최소 신뢰도 (이하면 미매칭 처리)
    min_confidence: 0.7

    # Embedding 매칭 설정
    embedding:
      enabled: true
      threshold: 0.75   # 유사도 임계값
      top_k: 3          # 후보 개수
      model: "text-embedding-3-small"

  # 정규식 패턴
  patterns:
    # Joint + 숫자 패턴
    - name: "joint_number"
      regex: '(?:joint|조인트|J)\s*(\d)'
      normalize: 'Joint {1}'
      examples:
        - "J3 → Joint 3"
        - "조인트 1 → Joint 1"
        - "joint5 → Joint 5"

    # N번 조인트 패턴
    - name: "joint_korean"
      regex: '(\d)\s*번\s*조인트'
      normalize: 'Joint {1}'
      examples:
        - "3번 조인트 → Joint 3"

# ------------------------------------------------------------
# 전처리 룰
# ------------------------------------------------------------
preprocessing:
  # 공백 정규화
  normalize_whitespace: true

  # 연속 공백 → 단일 공백
  collapse_whitespace: true

  # 특수문자 처리
  remove_special_chars: false  # 에러코드에 하이픈 있을 수 있음

  # 대소문자
  case_sensitive: false

  # 전처리 패턴 (순서대로 적용)
  patterns:
    # 하이픈 주변 공백 제거
    - find: '\s*-\s*'
      replace: '-'

# ------------------------------------------------------------
# 후처리 룰
# ------------------------------------------------------------
postprocessing:
  # 중복 제거
  deduplicate: true

  # 신뢰도 순 정렬
  sort_by_confidence: true

  # 최대 결과 수
  max_results: 10

# ------------------------------------------------------------
# 신뢰도 설정
# ------------------------------------------------------------
confidence:
  # 매칭 방식별 기본 신뢰도
  defaults:
    lexicon: 1.0      # 동의어 사전 매칭
    regex: 0.95       # 정규식 룰 매칭
    embedding: 0.8    # 임베딩 유사도 매칭

  # 보정 규칙
  adjustments:
    # 정확히 일치 (대소문자 무시)
    exact_match_bonus: 0.05
    # 부분 일치 패널티
    partial_match_penalty: -0.1
