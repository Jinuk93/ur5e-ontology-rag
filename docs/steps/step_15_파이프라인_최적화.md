# Step 15: 파이프라인 최적화 - 완료 보고서

## 1. 요약

| 항목 | 내용 |
|------|------|
| Phase | 15 - 파이프라인 최적화 |
| 상태 | **완료** |
| 날짜 | 2026-01-26 |
| 주요 산출물 | 리랭커 사전 로딩, 병렬 처리 |

---

## 2. 최적화 목표

### 2.1 문제점

| 문제 | 영향 | 원인 |
|------|------|------|
| 첫 요청 지연 ~20초 | UX 저하 | 리랭커 모델 로딩 |
| 순차 처리 | 응답 시간 증가 | 온톨로지/문서검색 직렬 실행 |

### 2.2 최적화 전 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                    최적화 전: 순차 처리                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  서버 시작                                                      │
│    │                                                            │
│    └─ 컴포넌트 초기화 (빠름)                                    │
│                                                                 │
│  첫 번째 요청                                                   │
│    │                                                            │
│    ├─ 1. 질문 분류 ─────────────────────────── ~50ms           │
│    │                                                            │
│    ├─ 2. 문서 검색 ─────────────────────────── ~20,000ms       │
│    │   └─ [리랭커 모델 로딩: ~20초]                             │
│    │                                                            │
│    ├─ 3. 온톨로지 추론 ─────────────────────── ~50ms           │
│    │                                                            │
│    └─ 4. 응답 생성 ─────────────────────────── ~50ms           │
│                                                                 │
│    총 소요: ~20초+ (첫 요청만)                                  │
│                                                                 │
│  이후 요청                                                      │
│    │                                                            │
│    └─ 문서검색(~200ms) → 온톨로지(~50ms) → 응답(~50ms)         │
│                                                                 │
│    총 소요: ~300-500ms (순차 처리)                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 최적화 내용

### 3.1 최적화 1: 리랭커 사전 로딩

```
┌─────────────────────────────────────────────────────────────────┐
│                    최적화 1: 사전 로딩                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  서버 시작                                                      │
│    │                                                            │
│    ├─ 컴포넌트 초기화                                           │
│    │   ├─ QueryClassifier  ───────────────── 즉시              │
│    │   ├─ OntologyEngine   ───────────────── 즉시              │
│    │   ├─ ResponseGenerator ──────────────── 즉시              │
│    │   └─ HybridRetriever  ───────────────── 즉시              │
│    │                                                            │
│    └─ 사전 로딩 (preload)                                       │
│        ├─ VectorStore 초기화 ─────────────── ~100ms            │
│        └─ Reranker 모델 로딩 ─────────────── ~20초             │
│                                                                 │
│  첫 번째 요청 (사전 로딩 완료 후)                               │
│    │                                                            │
│    └─ 정상 속도로 처리 (모델 이미 로드됨)                       │
│                                                                 │
│    총 소요: ~300-500ms (첫 요청부터!)                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**구현 코드:**

```python
# src/embedding/reranker.py
class CrossEncoderReranker:
    def preload(self) -> "CrossEncoderReranker":
        """모델 사전 로딩"""
        if self._model is None:
            logger.info("리랭커 모델 사전 로딩 시작...")
            self._load_model()
            logger.info("리랭커 모델 사전 로딩 완료")
        return self

    def is_loaded(self) -> bool:
        """모델 로드 상태 확인"""
        return self._model is not None
```

```python
# src/rag/hybrid_retriever.py
class HybridRetriever:
    def preload(self) -> "HybridRetriever":
        """VectorStore + Reranker 사전 로딩"""
        _ = self.vector_store  # VectorStore 초기화
        if self.use_reranker:
            reranker = get_reranker()
            reranker.preload()  # 모델 로딩
        return self
```

```python
# src/api/main.py - startup 이벤트
@app.on_event("startup")
async def startup():
    retriever = get_retriever()
    retriever.preload()  # 서버 시작 시 사전 로딩
```

---

### 3.2 최적화 2: 병렬 처리

```
┌─────────────────────────────────────────────────────────────────┐
│                    최적화 2: 병렬 처리                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  최적화 전 (순차)                                               │
│  ═════════════════                                              │
│                                                                 │
│  ├─ 문서 검색 ─────────────────────────────── 200ms            │
│  │                                                              │
│  └─ 온톨로지 추론 ─────────────────────────── 50ms             │
│                                                                 │
│  총 소요: 250ms (순차)                                          │
│                                                                 │
│  ────────────────────────────────────────────────────────────── │
│                                                                 │
│  최적화 후 (병렬)                                               │
│  ═════════════════                                              │
│                                                                 │
│  ├─ 문서 검색 ─────────────────────┐                           │
│  │                                 │ 동시 실행                  │
│  └─ 온톨로지 추론 ─────────────────┘                           │
│                                                                 │
│  총 소요: max(200ms, 50ms) = 200ms (병렬)                       │
│                                                                 │
│  절감: ~20% (50ms / 250ms)                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**구현 코드:**

```python
# src/api/routes/chat.py
async def chat(request: ChatRequest, ...):
    # 병렬 실행할 태스크 정의
    async def run_document_search():
        retriever = _get_retriever()
        result = await asyncio.to_thread(
            retriever.retrieve,
            classification.query,
            classification.query_type,
        )
        return result

    async def run_ontology_reasoning():
        engine = _get_engine()
        entities = [e.to_dict() for e in classification.entities]
        result = await asyncio.to_thread(
            engine.reason,
            classification.query,
            entities,
            request.context,
        )
        return result

    # 병렬 실행
    retrieval_result, reasoning = await asyncio.gather(
        run_document_search(),
        run_ontology_reasoning(),
    )
```

---

## 4. 수정된 파일

| 파일 | 변경 내용 |
|------|----------|
| [src/embedding/reranker.py](src/embedding/reranker.py) | `preload()`, `is_loaded()` 메서드 추가 |
| [src/rag/hybrid_retriever.py](src/rag/hybrid_retriever.py) | `preload()` 메서드 추가 |
| [src/api/main.py](src/api/main.py) | startup에서 `preload()` 호출 |
| [src/api/routes/chat.py](src/api/routes/chat.py) | `asyncio.gather()` 병렬 처리 |

---

## 5. 성능 비교

### 5.1 첫 번째 요청

| 항목 | 최적화 전 | 최적화 후 | 개선 |
|------|----------|----------|------|
| 리랭커 로딩 | 요청 시 ~20초 | 서버 시작 시 | 첫 요청 지연 제거 |
| 첫 요청 응답 | ~20초 | ~300-500ms | **98% 개선** |

### 5.2 이후 요청

| 항목 | 최적화 전 | 최적화 후 | 개선 |
|------|----------|----------|------|
| 문서 검색 | ~200ms | ~200ms | - |
| 온톨로지 추론 | ~50ms | ~50ms (병렬) | - |
| **총 응답 시간** | ~300-500ms | ~250-400ms | **~20% 개선** |

---

## 6. 최적화 전/후 아키텍처 비교

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    최적화 전/후 비교                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   [최적화 전]                          [최적화 후]                          │
│   ═══════════                          ═══════════                          │
│                                                                             │
│   서버 시작                            서버 시작                            │
│       │                                    │                                │
│       └─ 컴포넌트 초기화                   ├─ 컴포넌트 초기화               │
│           (지연 로딩)                       │                                │
│                                            └─ preload()                     │
│   첫 요청                                      ├─ VectorStore               │
│       │                                        └─ Reranker 모델 ← 미리 로드 │
│       ├─ 분류                                                               │
│       ├─ [모델 로딩 20초]               첫 요청                             │
│       ├─ 문서 검색 → 순차                  │                                │
│       ├─ 온톨로지 → 순차                   ├─ 분류                          │
│       └─ 응답 생성                         ├─ 문서 검색 ─┐ 병렬             │
│                                            ├─ 온톨로지 ──┘                  │
│   이후 요청                                └─ 응답 생성                     │
│       │                                                                     │
│       ├─ 분류                           이후 요청                           │
│       ├─ 문서 검색 → 순차                  │                                │
│       ├─ 온톨로지 → 순차                   └─ 동일 (병렬 처리)              │
│       └─ 응답 생성                                                          │
│                                                                             │
│   시간: 첫 요청 ~20초                    시간: 첫 요청 ~300ms               │
│         이후 ~300ms                           이후 ~250ms                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 설정 가이드

### 7.1 리랭커 비활성화 (속도 우선)

```yaml
# configs/settings.yaml
rerank:
  enabled: false  # 리랭킹 비활성화 → 더 빠름, 정확도 약간 감소
```

### 7.2 리랭커 모델 선택

```yaml
# configs/settings.yaml
rerank:
  model: "bge-reranker-base"   # 기본 (한국어 지원, 빠름)
  # model: "bge-reranker-large"  # 더 정확, 느림
```

---

## 8. 향후 추가 최적화 가능 항목

| 항목 | 설명 | 예상 효과 |
|------|------|----------|
| 결과 캐싱 | 자주 묻는 질문 캐싱 | 반복 질문 즉시 응답 |
| 배치 처리 | 여러 질문 동시 처리 | 처리량 증가 |
| GPU 활용 | CUDA 사용 | 리랭킹 ~50% 속도 향상 |
| 모델 양자화 | INT8 양자화 | 메모리/속도 개선 |

---

## 9. 요약

| 최적화 | 구현 위치 | 효과 |
|--------|----------|------|
| 사전 로딩 | `reranker.preload()`, `hybrid_retriever.preload()` | 첫 요청 지연 제거 |
| 병렬 처리 | `chat.py` `asyncio.gather()` | 응답 시간 ~20% 개선 |

```
┌─────────────────────────────────────────────────────────────────┐
│                    최적화 결과 요약                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   첫 요청 응답 시간:  20초 → 300ms  (98% 개선)                  │
│   이후 응답 시간:    300ms → 250ms  (20% 개선)                  │
│                                                                 │
│   서버 시작 시간:    ~20초 증가 (사전 로딩)                     │
│   → 운영 관점에서는 서버 시작이 조금 느려지지만,                │
│     사용자 경험은 크게 향상됨                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```
