# Phase 4: 온톨로지 설계

> **상태**: ✅ 완료
> **도메인**: 지식 레이어 (Knowledge)
> **목표**: UR5e 도메인 지식그래프 구축

---

## 1. 개요

UR5e 로봇 시스템의 도메인 지식을 그래프 형태로 모델링하고,
Neo4j에 적재하여 구조화된 지식 검색이 가능하도록 구성하는 단계.

---

## 2. 태스크

| # | 태스크 | 상태 |
|---|--------|------|
| 1 | Node 타입 설계 | ✅ |
| 2 | Relationship 타입 설계 | ✅ |
| 3 | ontology.json 작성 | ✅ |
| 4 | Neo4j 그래프 적재 | ✅ |
| 5 | Cypher 쿼리 작성 | ✅ |

---

## 3. 온톨로지 스키마

### 3.1 Node 타입

| Node | 속성 | 설명 |
|------|------|------|
| `ErrorCode` | code, message, severity | 에러 코드 (C1xxxx, S1xxxx, J0~J5xxxx) |
| `Component` | name, synonyms | 부품/컴포넌트 (Control Box, Joint 등) |
| `Cause` | cause_id, description | 에러 원인 |
| `Resolution` | resolution_id, text | 해결 방법 |
| `SensorPattern` | pattern_type, threshold | 센서 이상 패턴 (Phase 17 추가) |

### 3.2 Relationship 타입

| Relationship | From → To | 설명 |
|--------------|-----------|------|
| `HAS_CAUSE` | ErrorCode → Cause | 에러의 원인 |
| `HAS_RESOLUTION` | ErrorCode → Resolution | 에러의 해결책 |
| `AFFECTS` | ErrorCode → Component | 에러가 영향주는 부품 |
| `RELATED_TO` | ErrorCode → ErrorCode | 연관 에러 |
| `TRIGGERS` | Cause → ErrorCode | 원인이 유발하는 에러 |
| `INDICATES` | SensorPattern → Cause | 패턴이 나타내는 원인 |

### 3.3 그래프 구조 시각화

```
                    ┌──────────────┐
                    │ SensorPattern│
                    │  (collision) │
                    └──────┬───────┘
                           │ INDICATES
                           ▼
┌───────────────┐   ┌──────────────┐   ┌──────────────┐
│  Component    │◀──│    Cause     │──▶│  Resolution  │
│ (Control Box) │   │ (Fan failure)│   │ (Check fan)  │
└───────────────┘   └──────┬───────┘   └──────────────┘
        ▲                  │                   ▲
        │ AFFECTS   HAS_CAUSE                  │
        │                  ▼                   │
        │          ┌──────────────┐   HAS_RESOLUTION
        └──────────│  ErrorCode   │────────────┘
                   │  (C154A3)    │
                   └──────────────┘
```

---

## 4. 구현

### 4.1 ontology.json 구조

```json
{
  "nodes": {
    "ErrorCode": [
      {
        "code": "C154A3",
        "message": "Control box fan malfunction",
        "severity": "warning"
      }
    ],
    "Component": [
      {
        "name": "Control Box",
        "synonyms": ["controller", "control unit", "제어박스"]
      }
    ],
    "Cause": [
      {
        "cause_id": "cause_001",
        "description": "Fan failure or obstruction"
      }
    ],
    "Resolution": [
      {
        "resolution_id": "res_001",
        "text": "Check fan operation and clean dust"
      }
    ]
  },
  "relationships": [
    {
      "type": "HAS_CAUSE",
      "from": {"type": "ErrorCode", "code": "C154A3"},
      "to": {"type": "Cause", "cause_id": "cause_001"}
    }
  ]
}
```

### 4.2 핵심 코드

**그래프 스토어** (`src/ontology/graph_store.py`):
```python
from neo4j import GraphDatabase

class GraphStore:
    def __init__(self, uri: str, user: str, password: str):
        self.driver = GraphDatabase.driver(uri, auth=(user, password))

    def create_error_code(self, code: str, message: str, severity: str):
        """ErrorCode 노드 생성"""
        query = """
        MERGE (e:ErrorCode {code: $code})
        SET e.message = $message, e.severity = $severity
        """
        with self.driver.session() as session:
            session.run(query, code=code, message=message, severity=severity)

    def create_relationship(self, rel_type: str, from_node: dict, to_node: dict):
        """관계 생성"""
        query = f"""
        MATCH (a:{from_node['type']} {{{from_node['key']}: $from_val}})
        MATCH (b:{to_node['type']} {{{to_node['key']}: $to_val}})
        MERGE (a)-[:{rel_type}]->(b)
        """
        # ...
```

### 4.3 Cypher 쿼리 예시

**에러코드로 원인/해결책 조회**:
```cypher
MATCH (e:ErrorCode {code: 'C154A3'})
OPTIONAL MATCH (e)-[:HAS_CAUSE]->(c:Cause)
OPTIONAL MATCH (e)-[:HAS_RESOLUTION]->(r:Resolution)
OPTIONAL MATCH (e)-[:AFFECTS]->(comp:Component)
RETURN e, c, r, comp
```

**컴포넌트 관련 모든 에러 조회**:
```cypher
MATCH (comp:Component {name: 'Control Box'})
MATCH (e:ErrorCode)-[:AFFECTS]->(comp)
RETURN e.code, e.message
```

---

## 5. 산출물

### 5.1 파일 목록

| 파일 | 내용 | 크기 |
|------|------|------|
| `data/processed/ontology/ontology.json` | 온톨로지 정의 | 3.7KB |
| `src/ontology/graph_store.py` | Neo4j 연동 | ~200 lines |
| `src/ontology/schema.py` | 스키마 정의 | ~100 lines |
| `scripts/load_ontology.py` | 적재 스크립트 | ~50 lines |

### 5.2 그래프 통계

| Node 타입 | 개수 |
|-----------|------|
| ErrorCode | 56+ |
| Component | 10+ |
| Cause | 85+ |
| Resolution | 120+ |
| SensorPattern | 4 (Phase 17 추가) |

| Relationship | 개수 |
|--------------|------|
| HAS_CAUSE | 85+ |
| HAS_RESOLUTION | 120+ |
| AFFECTS | 50+ |
| RELATED_TO | 20+ |

---

## 6. 검증 체크리스트

- [x] 모든 Node 타입 생성 완료
- [x] 모든 Relationship 타입 생성 완료
- [x] Neo4j 브라우저에서 그래프 시각화 확인
- [x] Cypher 쿼리 테스트 성공
- [x] ontology.json 유효성 검증

---

## 7. 다음 단계

→ [Phase 05: 기본 RAG](05_기본RAG.md)

---

**Phase**: 4 / 19
**작성일**: 2026-01-22
