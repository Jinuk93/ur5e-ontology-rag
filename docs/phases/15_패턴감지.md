# Phase 15: 패턴 감지

> **상태**: ✅ 완료
> **도메인**: 데이터 레이어 (Data) / 센서
> **목표**: 센서 데이터에서 이상 패턴 자동 감지
> **이전 명칭**: Main-S2

---

## 1. 개요

Phase 14에서 생성한 센서 데이터에서 collision, vibration, overload, drift 등
4가지 이상 패턴을 자동으로 감지하는 PatternDetector를 구현하는 단계.

---

## 2. 태스크

| # | 태스크 | 상태 |
|---|--------|------|
| 1 | PatternDetector 클래스 설계 | ✅ |
| 2 | 4가지 패턴 감지 알고리즘 구현 | ✅ |
| 3 | SensorStore 구현 | ✅ |
| 4 | pattern_thresholds.yaml 작성 | ✅ |
| 5 | 단위 테스트 (26개) | ✅ |

---

## 3. 패턴 감지 알고리즘

### 3.1 알고리즘 개요

```
┌─────────────────────────────────────────────────────────────┐
│                    PatternDetector                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [1] Collision Detection                                    │
│      └─▶ 조건: |dF/dt| > 100 N/s                           │
│      └─▶ 방법: 1차 미분, 급격한 변화 감지                     │
│                                                             │
│  [2] Vibration Detection                                    │
│      └─▶ 조건: FFT 고주파 성분 > threshold                   │
│      └─▶ 방법: 주파수 분석 (5Hz 이상)                        │
│                                                             │
│  [3] Overload Detection                                     │
│      └─▶ 조건: |F| > 200N, duration > 5s                   │
│      └─▶ 방법: 이동 평균 + 지속 시간 확인                     │
│                                                             │
│  [4] Drift Detection                                        │
│      └─▶ 조건: baseline 이동 > 5N over 1h                   │
│      └─▶ 방법: 장기 트렌드 분석                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 감지 흐름

```
센서 데이터 (Parquet)
       │
       ▼
┌─────────────┐
│ SensorStore │ ─▶ 데이터 로드 및 전처리
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────────┐
│            PatternDetector                  │
│  ┌───────────┐  ┌───────────┐              │
│  │ collision │  │ vibration │              │
│  └─────┬─────┘  └─────┬─────┘              │
│        │              │                     │
│  ┌─────┴─────┐  ┌─────┴─────┐              │
│  │ overload  │  │   drift   │              │
│  └─────┬─────┘  └─────┬─────┘              │
│        └──────┬───────┘                     │
└───────────────┼─────────────────────────────┘
                │
                ▼
       detected_patterns.json
```

---

## 4. 구현

### 4.1 PatternDetector 클래스

```python
# src/sensor/pattern_detector.py

import numpy as np
from scipy import signal
from scipy.fft import fft, fftfreq
from dataclasses import dataclass
from typing import List, Optional
from datetime import datetime

@dataclass
class DetectedPattern:
    pattern_type: str       # collision, vibration, overload, drift
    start_time: datetime
    end_time: datetime
    severity: str           # low, medium, high
    confidence: float       # 0.0 ~ 1.0
    affected_axes: List[str]
    peak_value: float
    metadata: dict

class PatternDetector:
    def __init__(self, config_path: str = "configs/pattern_thresholds.yaml"):
        self.thresholds = self._load_thresholds(config_path)

    def detect_all(self, df: pd.DataFrame) -> List[DetectedPattern]:
        """모든 패턴 감지 실행"""
        patterns = []
        patterns.extend(self.detect_collision(df))
        patterns.extend(self.detect_vibration(df))
        patterns.extend(self.detect_overload(df))
        patterns.extend(self.detect_drift(df))
        return self._merge_overlapping(patterns)

    def detect_collision(self, df: pd.DataFrame) -> List[DetectedPattern]:
        """충돌 감지: 급격한 힘 변화"""
        patterns = []
        force_axes = ["Fx", "Fy", "Fz"]

        for axis in force_axes:
            # 1차 미분 (변화율)
            derivative = np.gradient(df[axis].values)

            # 임계값 초과 지점 찾기
            threshold = self.thresholds["collision"]["derivative_threshold"]
            peaks, properties = signal.find_peaks(
                np.abs(derivative),
                height=threshold,
                distance=10  # 최소 10 샘플 간격
            )

            for peak_idx in peaks:
                patterns.append(DetectedPattern(
                    pattern_type="collision",
                    start_time=df["timestamp"].iloc[max(0, peak_idx-5)],
                    end_time=df["timestamp"].iloc[min(len(df)-1, peak_idx+50)],
                    severity=self._calculate_severity(derivative[peak_idx], "collision"),
                    confidence=min(1.0, np.abs(derivative[peak_idx]) / threshold),
                    affected_axes=[axis],
                    peak_value=float(derivative[peak_idx]),
                    metadata={"axis": axis, "index": int(peak_idx)}
                ))

        return patterns

    def detect_vibration(self, df: pd.DataFrame) -> List[DetectedPattern]:
        """진동 감지: 주파수 분석"""
        patterns = []
        window_size = 1000  # 1초 윈도우 (1000Hz 기준)

        for axis in ["Fx", "Fy", "Fz"]:
            for i in range(0, len(df) - window_size, window_size // 2):
                window = df[axis].iloc[i:i+window_size].values

                # FFT
                yf = fft(window)
                xf = fftfreq(window_size, 1/1000)

                # 5Hz 이상 고주파 에너지
                high_freq_mask = (xf > 5) & (xf < 100)
                high_freq_energy = np.sum(np.abs(yf[high_freq_mask]))

                threshold = self.thresholds["vibration"]["energy_threshold"]
                if high_freq_energy > threshold:
                    patterns.append(DetectedPattern(
                        pattern_type="vibration",
                        start_time=df["timestamp"].iloc[i],
                        end_time=df["timestamp"].iloc[i+window_size-1],
                        severity=self._calculate_severity(high_freq_energy, "vibration"),
                        confidence=min(1.0, high_freq_energy / threshold / 2),
                        affected_axes=[axis],
                        peak_value=float(high_freq_energy),
                        metadata={"dominant_freq": float(xf[np.argmax(np.abs(yf))])}
                    ))

        return patterns

    def detect_overload(self, df: pd.DataFrame) -> List[DetectedPattern]:
        """과부하 감지: 지속적 고하중"""
        patterns = []
        threshold = self.thresholds["overload"]["force_threshold"]
        min_duration = self.thresholds["overload"]["min_duration_seconds"]

        for axis in ["Fz"]:  # 주로 Z축 과부하
            above_threshold = np.abs(df[axis].values) > threshold

            # 연속 구간 찾기
            regions = self._find_continuous_regions(above_threshold)

            for start_idx, end_idx in regions:
                duration = (end_idx - start_idx) / 1  # 1Hz 기준
                if duration >= min_duration:
                    patterns.append(DetectedPattern(
                        pattern_type="overload",
                        start_time=df["timestamp"].iloc[start_idx],
                        end_time=df["timestamp"].iloc[end_idx],
                        severity="high",
                        confidence=0.95,
                        affected_axes=[axis],
                        peak_value=float(df[axis].iloc[start_idx:end_idx].max()),
                        metadata={"duration_seconds": duration}
                    ))

        return patterns

    def detect_drift(self, df: pd.DataFrame) -> List[DetectedPattern]:
        """드리프트 감지: 장기 기준점 이동"""
        patterns = []
        window_hours = 1
        window_size = window_hours * 3600  # 1시간 (1Hz 기준)
        threshold = self.thresholds["drift"]["baseline_shift"]

        for axis in ["Fx", "Fy", "Fz", "Tx", "Ty", "Tz"]:
            # 이동 평균으로 트렌드 추출
            rolling_mean = df[axis].rolling(window=window_size, min_periods=100).mean()

            # 기준점 이동 감지
            baseline_shift = rolling_mean.diff(periods=window_size)

            drift_points = np.where(np.abs(baseline_shift) > threshold)[0]

            if len(drift_points) > 0:
                patterns.append(DetectedPattern(
                    pattern_type="drift",
                    start_time=df["timestamp"].iloc[drift_points[0]],
                    end_time=df["timestamp"].iloc[drift_points[-1]],
                    severity="medium",
                    confidence=0.8,
                    affected_axes=[axis],
                    peak_value=float(baseline_shift.max()),
                    metadata={"axis": axis}
                ))

        return patterns
```

### 4.2 SensorStore 클래스

```python
# src/sensor/sensor_store.py

import pandas as pd
from pathlib import Path
from typing import Optional, List
from datetime import datetime

class SensorStore:
    def __init__(self, data_dir: str = "data/sensor"):
        self.data_dir = Path(data_dir)

    def load_data(
        self,
        start_time: Optional[datetime] = None,
        end_time: Optional[datetime] = None,
        axes: Optional[List[str]] = None
    ) -> pd.DataFrame:
        """센서 데이터 로드"""
        parquet_files = list(self.data_dir.glob("raw/*.parquet"))

        dfs = []
        for file in parquet_files:
            df = pd.read_parquet(file)
            dfs.append(df)

        combined = pd.concat(dfs, ignore_index=True)

        # 시간 필터
        if start_time:
            combined = combined[combined["timestamp"] >= start_time]
        if end_time:
            combined = combined[combined["timestamp"] <= end_time]

        # 축 필터
        if axes:
            columns = ["timestamp"] + axes + ["status"]
            combined = combined[columns]

        return combined.sort_values("timestamp").reset_index(drop=True)

    def get_patterns(self) -> List[dict]:
        """감지된 패턴 목록 로드"""
        pattern_file = self.data_dir / "processed/detected_patterns.json"
        if pattern_file.exists():
            return json.loads(pattern_file.read_text())
        return []

    def save_patterns(self, patterns: List[DetectedPattern]) -> None:
        """감지된 패턴 저장"""
        pattern_file = self.data_dir / "processed/detected_patterns.json"
        pattern_data = [asdict(p) for p in patterns]
        pattern_file.write_text(json.dumps(pattern_data, default=str, indent=2))
```

---

## 5. 임계값 설정

### 5.1 pattern_thresholds.yaml

```yaml
# configs/pattern_thresholds.yaml

collision:
  derivative_threshold: 100  # N/s
  min_peak_force: 50         # N
  severity:
    low: 50
    medium: 100
    high: 150

vibration:
  energy_threshold: 5000     # FFT 에너지
  min_frequency: 5           # Hz
  max_frequency: 100         # Hz
  severity:
    low: 5000
    medium: 10000
    high: 20000

overload:
  force_threshold: 200       # N
  min_duration_seconds: 5    # 초
  severity:
    low: 200
    medium: 300
    high: 400

drift:
  baseline_shift: 5          # N
  window_hours: 1            # 시간
  severity:
    low: 5
    medium: 10
    high: 20
```

---

## 6. 산출물

### 6.1 파일 목록

| 파일 | 내용 | Lines/크기 |
|------|------|-----------|
| `src/sensor/pattern_detector.py` | 패턴 감지기 | ~350 lines |
| `src/sensor/sensor_store.py` | 센서 저장소 | ~370 lines |
| `configs/pattern_thresholds.yaml` | 임계값 설정 | 3.0KB |
| `data/sensor/processed/detected_patterns.json` | 감지 결과 | 17개 패턴 |
| `tests/test_pattern_detector.py` | 단위 테스트 | 26개 |

### 6.2 감지 결과

| 패턴 유형 | 감지 수 | 삽입 수 | Recall |
|-----------|---------|---------|--------|
| collision | 3 | 2 | 100% |
| vibration | 4 | 2 | 100% |
| overload | 5 | 2 | 100% |
| drift | 5 | 1 | 100% |
| **총계** | **17** | **7** | **100%** |

### 6.3 성능 지표

| 지표 | 값 |
|------|-----|
| Recall | 100% (7/7 삽입 이벤트) |
| Precision | 41.18% (7/17 - 추가 감지 포함) |
| F1 Score | 58.33% |

---

## 7. 테스트 결과

```
========================= test session starts ==========================
tests/test_pattern_detector.py::test_detect_collision PASSED
tests/test_pattern_detector.py::test_detect_vibration PASSED
tests/test_pattern_detector.py::test_detect_overload PASSED
tests/test_pattern_detector.py::test_detect_drift PASSED
tests/test_pattern_detector.py::test_threshold_config PASSED
tests/test_pattern_detector.py::test_sensor_store_load PASSED
...
========================= 26 passed in 1.23s ===========================
```

---

## 8. 검증 체크리스트

- [x] PatternDetector 4가지 패턴 감지 구현
- [x] SensorStore 데이터 로드/저장 구현
- [x] pattern_thresholds.yaml 작성
- [x] detected_patterns.json 생성 (17개)
- [x] Recall 100% 달성
- [x] 26개 단위 테스트 100% 통과

---

## 9. 다음 단계

→ [Phase 16: Context Enricher](16_ContextEnricher.md)

---

**Phase**: 15 / 19
**작성일**: 2026-01-22
