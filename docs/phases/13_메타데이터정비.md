# Phase 13: 메타데이터 정비

> **상태**: ✅ 완료
> **도메인**: 데이터 레이어 (Data)
> **목표**: 근거 추적을 위한 메타데이터 체계 구축
> **이전 명칭**: Main-F3

---

## 1. 개요

청크에서 원본 문서까지의 추적 경로를 명확히 하기 위해
sources.yaml(문서 메타)과 chunk_manifest.jsonl(청크 매핑)을 구축하는 단계.

---

## 2. 태스크

| # | 태스크 | 상태 |
|---|--------|------|
| 1 | sources.yaml 작성 | ✅ |
| 2 | chunk_manifest.jsonl 생성 | ✅ |
| 3 | ManifestGenerator 구현 | ✅ |
| 4 | MetadataService 구현 | ✅ |
| 5 | 단위 테스트 작성 | ✅ |

---

## 3. 메타데이터 구조

### 3.1 데이터 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                    메타데이터 추적 체계                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  sources.yaml                                               │
│  ├─ doc_id: "service_manual"                               │
│  ├─ title: "UR5e Service Manual"                           │
│  ├─ file_path: "data/raw/pdf/service_manual.pdf"           │
│  └─ total_pages: 300                                       │
│           │                                                 │
│           ▼                                                 │
│  chunk_manifest.jsonl                                       │
│  ├─ chunk_id: "service_manual_p042_c003"                   │
│  ├─ doc_id: "service_manual"                               │
│  ├─ page: 42                                               │
│  ├─ start_char: 1500                                       │
│  └─ end_char: 2000                                         │
│           │                                                 │
│           ▼                                                 │
│  ChromaDB (벡터 인덱스)                                      │
│  └─ chunk_id로 검색 결과 반환                                │
│           │                                                 │
│           ▼                                                 │
│  Evidence (근거 표시)                                        │
│  └─ "Service Manual p.42" 형태로 출처 표시                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. sources.yaml

### 4.1 구조

```yaml
# data/processed/metadata/sources.yaml

documents:
  - doc_id: "service_manual"
    title: "UR5e Service Manual"
    version: "5.11"
    language: "en"
    file_path: "data/raw/pdf/service_manual.pdf"
    file_hash: "sha256:abc123..."
    total_pages: 300
    total_chunks: 405
    sections:
      - name: "Safety"
        start_page: 1
        end_page: 20
      - name: "Troubleshooting"
        start_page: 200
        end_page: 250
    metadata:
      publisher: "Universal Robots"
      publication_date: "2023-06"
      url: "https://www.universal-robots.com/..."

  - doc_id: "error_codes"
    title: "UR5e Error Codes Reference"
    version: "5.11"
    language: "en"
    file_path: "data/raw/pdf/error_codes.pdf"
    file_hash: "sha256:def456..."
    total_pages: 50
    total_chunks: 152
    metadata:
      publisher: "Universal Robots"

  - doc_id: "user_manual"
    title: "UR5e User Manual"
    version: "5.11"
    language: "en"
    file_path: "data/raw/pdf/user_manual.pdf"
    file_hash: "sha256:ghi789..."
    total_pages: 200
    total_chunks: 165
    metadata:
      publisher: "Universal Robots"
```

### 4.2 통계

| 문서 | 페이지 | 청크 | 파일 크기 |
|------|--------|------|----------|
| Service Manual | 300 | 405 | 15MB |
| Error Codes | 50 | 152 | 3MB |
| User Manual | 200 | 165 | 10MB |
| **총계** | **550** | **722** | **28MB** |

---

## 5. chunk_manifest.jsonl

### 5.1 구조

```jsonl
{"chunk_id":"service_manual_p001_c001","doc_id":"service_manual","page":1,"chunk_index":1,"start_char":0,"end_char":487,"text_preview":"Safety instructions...","section":"Safety"}
{"chunk_id":"service_manual_p001_c002","doc_id":"service_manual","page":1,"chunk_index":2,"start_char":437,"end_char":924,"text_preview":"Warning symbols...","section":"Safety"}
{"chunk_id":"service_manual_p042_c003","doc_id":"service_manual","page":42,"chunk_index":3,"start_char":1500,"end_char":2000,"text_preview":"Troubleshooting steps...","section":"Troubleshooting"}
...
```

### 5.2 필드 설명

| 필드 | 설명 |
|------|------|
| chunk_id | 청크 고유 ID |
| doc_id | 원본 문서 ID |
| page | 원본 페이지 번호 |
| chunk_index | 페이지 내 청크 순서 |
| start_char | 페이지 내 시작 문자 위치 |
| end_char | 페이지 내 종료 문자 위치 |
| text_preview | 텍스트 미리보기 (50자) |
| section | 섹션 이름 (선택) |

---

## 6. 구현

### 6.1 ManifestGenerator

```python
# src/ingestion/manifest_generator.py

import json
import hashlib
from pathlib import Path
from typing import List
from dataclasses import dataclass, asdict

@dataclass
class ChunkManifestEntry:
    chunk_id: str
    doc_id: str
    page: int
    chunk_index: int
    start_char: int
    end_char: int
    text_preview: str
    section: str = ""

class ManifestGenerator:
    def __init__(self, output_path: str):
        self.output_path = Path(output_path)

    def generate(self, chunks: List[Chunk]) -> None:
        """청크 목록에서 manifest 생성"""
        with open(self.output_path, "w", encoding="utf-8") as f:
            for chunk in chunks:
                entry = ChunkManifestEntry(
                    chunk_id=chunk.chunk_id,
                    doc_id=chunk.doc_id,
                    page=chunk.page,
                    chunk_index=chunk.chunk_index,
                    start_char=chunk.start_char,
                    end_char=chunk.end_char,
                    text_preview=chunk.text[:50] + "...",
                    section=chunk.metadata.get("section", "")
                )
                f.write(json.dumps(asdict(entry), ensure_ascii=False) + "\n")

    def validate(self) -> bool:
        """manifest 유효성 검증"""
        chunk_ids = set()
        with open(self.output_path, "r", encoding="utf-8") as f:
            for line in f:
                entry = json.loads(line)
                if entry["chunk_id"] in chunk_ids:
                    return False  # 중복 ID
                chunk_ids.add(entry["chunk_id"])
        return True
```

### 6.2 MetadataService

```python
# src/api/services/metadata_service.py

import yaml
import json
from pathlib import Path
from typing import Optional, Dict

class MetadataService:
    def __init__(
        self,
        sources_path: str = "data/processed/metadata/sources.yaml",
        manifest_path: str = "data/processed/metadata/chunk_manifest.jsonl"
    ):
        self.sources = self._load_sources(sources_path)
        self.manifest_index = self._build_manifest_index(manifest_path)

    def get_document_info(self, doc_id: str) -> Optional[Dict]:
        """문서 정보 조회"""
        for doc in self.sources["documents"]:
            if doc["doc_id"] == doc_id:
                return doc
        return None

    def get_chunk_info(self, chunk_id: str) -> Optional[Dict]:
        """청크 정보 조회"""
        return self.manifest_index.get(chunk_id)

    def get_source_citation(self, chunk_id: str) -> str:
        """출처 문자열 생성"""
        chunk_info = self.get_chunk_info(chunk_id)
        if not chunk_info:
            return "Unknown source"

        doc_info = self.get_document_info(chunk_info["doc_id"])
        doc_title = doc_info["title"] if doc_info else chunk_info["doc_id"]

        return f"{doc_title}, p.{chunk_info['page']}"

    def _build_manifest_index(self, path: str) -> Dict:
        """chunk_id → chunk_info 인덱스 생성"""
        index = {}
        with open(path, "r", encoding="utf-8") as f:
            for line in f:
                entry = json.loads(line)
                index[entry["chunk_id"]] = entry
        return index
```

---

## 7. 산출물

### 7.1 파일 목록

| 파일 | 내용 | 크기/개수 |
|------|------|----------|
| `data/processed/metadata/sources.yaml` | 문서 메타데이터 | 3.98KB (3 문서) |
| `data/processed/metadata/chunk_manifest.jsonl` | 청크 매핑 | 183KB (722 청크) |
| `src/ingestion/manifest_generator.py` | 생성기 | ~100 lines |
| `src/api/services/metadata_service.py` | 서비스 | ~120 lines |
| `tests/test_metadata_service.py` | 단위 테스트 | 27개 |

### 7.2 테스트 결과

```
========================= test session starts ==========================
tests/test_metadata_service.py::test_get_document_info PASSED
tests/test_metadata_service.py::test_get_chunk_info PASSED
tests/test_metadata_service.py::test_get_source_citation PASSED
tests/test_metadata_service.py::test_manifest_validation PASSED
...
========================= 27 passed in 0.52s ===========================
```

---

## 8. 사용 예시

### 8.1 출처 표시

```python
metadata_service = MetadataService()

# 청크 ID로 출처 생성
chunk_id = "error_codes_p015_c002"
citation = metadata_service.get_source_citation(chunk_id)
print(citation)  # "UR5e Error Codes Reference, p.15"
```

### 8.2 API 응답에서 출처

```json
{
  "answer": "C154A3는 Control Box 팬 오작동...",
  "sources": [
    {
      "chunk_id": "error_codes_p015_c002",
      "citation": "UR5e Error Codes Reference, p.15",
      "score": 0.92
    }
  ]
}
```

---

## 9. 검증 체크리스트

- [x] sources.yaml: 3개 문서 메타데이터
- [x] chunk_manifest.jsonl: 722개 청크 매핑
- [x] 중복 chunk_id 없음 확인
- [x] MetadataService 조회 기능 동작
- [x] 출처 문자열 생성 동작
- [x] 27개 단위 테스트 100% 통과

---

## 10. 다음 단계

→ [Phase 14: 센서 데이터 생성](14_센서데이터생성.md)

---

**Phase**: 13 / 19
**마일스톤**: Foundation 개선 (Phase 11-13) ✅ 완료
**작성일**: 2026-01-22
