# Phase 17: 온톨로지 확장

> **상태**: ✅ 완료
> **도메인**: 지식 레이어 (Knowledge)
> **목표**: 센서 패턴을 온톨로지에 통합
> **이전 명칭**: Main-S4

---

## 1. 개요

기존 온톨로지에 SensorPattern 노드와 관련 관계(INDICATES, TRIGGERS)를 추가하여
센서 데이터와 에러코드 간의 연결을 그래프로 표현하는 단계.

---

## 2. 태스크

| # | 태스크 | 상태 |
|---|--------|------|
| 1 | SensorPattern 노드 스키마 정의 | ✅ |
| 2 | INDICATES, TRIGGERS 관계 정의 | ✅ |
| 3 | ontology.json 확장 | ✅ |
| 4 | GraphRetriever 확장 | ✅ |
| 5 | 단위 테스트 (17개) | ✅ |

---

## 3. 확장된 온톨로지 스키마

### 3.1 새 노드: SensorPattern

| 속성 | 타입 | 설명 |
|------|------|------|
| pattern_type | string | 패턴 유형 (collision, vibration, overload, drift) |
| description | string | 패턴 설명 |
| threshold | object | 감지 임계값 |
| severity_default | string | 기본 심각도 |

### 3.2 새 관계

| 관계 | From → To | 설명 |
|------|-----------|------|
| `INDICATES` | SensorPattern → Cause | 패턴이 나타내는 원인 |
| `TRIGGERS` | SensorPattern → ErrorCode | 패턴이 유발할 수 있는 에러 |

### 3.3 확장된 그래프 구조

```
                    ┌──────────────────┐
                    │  SensorPattern   │
                    │   (collision)    │
                    └────────┬─────────┘
                             │
            ┌────────────────┼────────────────┐
            │ INDICATES      │                │ TRIGGERS
            ▼                ▼                ▼
    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
    │    Cause     │  │    Cause     │  │  ErrorCode   │
    │(Impact force)│  │(Obstruction) │  │  (S10001)    │
    └──────┬───────┘  └──────┬───────┘  └──────────────┘
           │                 │
           │ TRIGGERS        │ TRIGGERS
           ▼                 ▼
    ┌──────────────┐  ┌──────────────┐
    │  ErrorCode   │  │  ErrorCode   │
    │  (J1A505)    │  │  (J2A505)    │
    └──────────────┘  └──────────────┘
```

---

## 4. ontology.json 확장

### 4.1 추가된 SensorPattern 노드

```json
{
  "nodes": {
    "SensorPattern": [
      {
        "pattern_type": "collision",
        "description": "Sudden force spike indicating physical impact",
        "threshold": {
          "derivative": 100,
          "min_force": 50
        },
        "severity_default": "high",
        "affected_axes": ["Fx", "Fy", "Fz"]
      },
      {
        "pattern_type": "vibration",
        "description": "High-frequency oscillation in force readings",
        "threshold": {
          "frequency_min": 5,
          "energy": 5000
        },
        "severity_default": "medium",
        "affected_axes": ["Fx", "Fy"]
      },
      {
        "pattern_type": "overload",
        "description": "Sustained high force exceeding normal limits",
        "threshold": {
          "force": 200,
          "duration_seconds": 5
        },
        "severity_default": "high",
        "affected_axes": ["Fz"]
      },
      {
        "pattern_type": "drift",
        "description": "Gradual baseline shift in sensor readings",
        "threshold": {
          "shift": 5,
          "window_hours": 1
        },
        "severity_default": "low",
        "affected_axes": ["Fx", "Fy", "Fz", "Tx", "Ty", "Tz"]
      }
    ]
  }
}
```

### 4.2 추가된 Cause 노드 (센서 관련)

```json
{
  "Cause": [
    {
      "cause_id": "sensor_cause_001",
      "description": "Physical impact or collision with obstacle"
    },
    {
      "cause_id": "sensor_cause_002",
      "description": "Mechanical resonance or loose components"
    },
    {
      "cause_id": "sensor_cause_003",
      "description": "Payload exceeding rated capacity"
    },
    {
      "cause_id": "sensor_cause_004",
      "description": "Excessive working speed"
    },
    {
      "cause_id": "sensor_cause_005",
      "description": "Sensor calibration drift"
    },
    {
      "cause_id": "sensor_cause_006",
      "description": "Temperature variation"
    },
    {
      "cause_id": "sensor_cause_007",
      "description": "Mechanical wear in joints"
    }
  ]
}
```

### 4.3 추가된 관계

```json
{
  "relationships": [
    {
      "type": "INDICATES",
      "from": {"type": "SensorPattern", "pattern_type": "collision"},
      "to": {"type": "Cause", "cause_id": "sensor_cause_001"}
    },
    {
      "type": "INDICATES",
      "from": {"type": "SensorPattern", "pattern_type": "vibration"},
      "to": {"type": "Cause", "cause_id": "sensor_cause_002"}
    },
    {
      "type": "INDICATES",
      "from": {"type": "SensorPattern", "pattern_type": "overload"},
      "to": {"type": "Cause", "cause_id": "sensor_cause_003"}
    },
    {
      "type": "TRIGGERS",
      "from": {"type": "SensorPattern", "pattern_type": "collision"},
      "to": {"type": "ErrorCode", "code": "S10001"}
    },
    {
      "type": "TRIGGERS",
      "from": {"type": "SensorPattern", "pattern_type": "collision"},
      "to": {"type": "ErrorCode", "code": "J1A505"}
    }
  ]
}
```

---

## 5. GraphRetriever 확장

### 5.1 새 메서드

```python
# src/rag/graph_retriever.py (확장)

class GraphRetriever:
    # ... 기존 메서드 ...

    def search_sensor_pattern_causes(
        self, pattern_type: str
    ) -> List[Cause]:
        """센서 패턴으로 가능한 원인 조회"""
        query = """
        MATCH (sp:SensorPattern {pattern_type: $pattern_type})
        MATCH (sp)-[:INDICATES]->(c:Cause)
        RETURN c
        """
        return self._execute_query(query, {"pattern_type": pattern_type})

    def search_sensor_pattern_errors(
        self, pattern_type: str
    ) -> List[ErrorCode]:
        """센서 패턴으로 가능한 에러코드 조회"""
        query = """
        MATCH (sp:SensorPattern {pattern_type: $pattern_type})
        MATCH (sp)-[:TRIGGERS]->(e:ErrorCode)
        RETURN e
        """
        return self._execute_query(query, {"pattern_type": pattern_type})

    def search_error_patterns(
        self, error_code: str
    ) -> List[SensorPattern]:
        """에러코드 관련 센서 패턴 역조회"""
        query = """
        MATCH (e:ErrorCode {code: $code})
        MATCH (sp:SensorPattern)-[:TRIGGERS]->(e)
        RETURN sp
        """
        return self._execute_query(query, {"code": error_code})

    def search_integrated_path(
        self, pattern_type: str, error_code: str
    ) -> Optional[GraphPath]:
        """센서패턴 → 원인 → 에러코드 전체 경로 조회"""
        query = """
        MATCH path = (sp:SensorPattern {pattern_type: $pattern_type})
                     -[:INDICATES]->(c:Cause)
                     -[:TRIGGERS]->(e:ErrorCode {code: $code})
        RETURN path
        """
        return self._execute_query(query, {
            "pattern_type": pattern_type,
            "code": error_code
        })

    def get_all_sensor_patterns(self) -> List[SensorPattern]:
        """모든 센서 패턴 조회"""
        query = """
        MATCH (sp:SensorPattern)
        RETURN sp
        """
        return self._execute_query(query)
```

### 5.2 스키마 확장

```python
# src/ontology/schema.py (확장)

from dataclasses import dataclass
from typing import List, Dict, Optional

@dataclass
class SensorPattern:
    pattern_type: str
    description: str
    threshold: Dict
    severity_default: str
    affected_axes: List[str]

@dataclass
class GraphPath:
    nodes: List[dict]
    relationships: List[dict]
    path_type: str  # e.g., "pattern_to_error"
```

---

## 6. 산출물

### 6.1 파일 목록

| 파일 | 내용 | 변경 사항 |
|------|------|----------|
| `data/processed/ontology/ontology.json` | 온톨로지 정의 | +4 SensorPattern, +7 Cause, +11 관계 |
| `src/ontology/schema.py` | 스키마 정의 | +SensorPattern, +GraphPath 클래스 |
| `src/rag/graph_retriever.py` | 그래프 검색 | +4 새 메서드 |
| `tests/test_ontology_sensor.py` | 단위 테스트 | 17개 |

### 6.2 온톨로지 통계 (확장 후)

| 항목 | 이전 | 이후 | 변화 |
|------|------|------|------|
| SensorPattern | 0 | 4 | +4 |
| Cause | 85+ | 92+ | +7 |
| INDICATES | 0 | 7 | +7 |
| TRIGGERS | 0 | 4 | +4 |

### 6.3 테스트 결과

```
========================= test session starts ==========================
tests/test_ontology_sensor.py::test_sensor_pattern_node PASSED
tests/test_ontology_sensor.py::test_indicates_relationship PASSED
tests/test_ontology_sensor.py::test_triggers_relationship PASSED
tests/test_ontology_sensor.py::test_search_pattern_causes PASSED
tests/test_ontology_sensor.py::test_search_pattern_errors PASSED
tests/test_ontology_sensor.py::test_search_error_patterns PASSED
tests/test_ontology_sensor.py::test_integrated_path PASSED
...
========================= 17 passed in 0.89s ===========================
```

---

## 7. Cypher 쿼리 예시

### 7.1 충돌 패턴 → 원인 조회

```cypher
MATCH (sp:SensorPattern {pattern_type: 'collision'})
MATCH (sp)-[:INDICATES]->(c:Cause)
RETURN sp.description, c.description

-- 결과:
-- "Sudden force spike..." | "Physical impact or collision"
```

### 7.2 에러코드 → 관련 패턴 역조회

```cypher
MATCH (e:ErrorCode {code: 'S10001'})
MATCH (sp:SensorPattern)-[:TRIGGERS]->(e)
RETURN sp.pattern_type, e.message

-- 결과:
-- "collision" | "Emergency stop activated"
-- "overload"  | "Emergency stop activated"
```

### 7.3 전체 경로 조회

```cypher
MATCH path = (sp:SensorPattern)-[:INDICATES]->(c:Cause)-[:TRIGGERS]->(e:ErrorCode)
WHERE sp.pattern_type = 'collision'
RETURN path
```

---

## 8. 검증 체크리스트

- [x] SensorPattern 노드 4개 추가
- [x] Cause 노드 7개 추가 (센서 관련)
- [x] INDICATES 관계 7개 추가
- [x] TRIGGERS 관계 4개 추가
- [x] GraphRetriever 새 메서드 4개 추가
- [x] 17개 단위 테스트 100% 통과

---

## 9. 다음 단계

→ [Phase 18: Verifier 확장](18_Verifier확장.md)

---

**Phase**: 17 / 19
**작성일**: 2026-01-22
